# Журнал доработок проекта

## 25 декабря 2025 г.

### Исправление критических ошибок и улучшение точности отслеживания цен:

1.  **Исправлен баг "отставания" цен (Queue Lag):**
    *   **Проблема:** Ранее бот забирал из очереди WebSocket только одно (самое старое) сообщение за цикл (раз в 0.3 сек). При активном рынке Bybit присылал десятки обновлений в секунду, из-за чего очередь росла, и бот обрабатывал цены с огромным опозданием (минуты/часы).
    *   **Решение:** Логика изменена на полное вычитывание очереди в каждом цикле. Бот теперь всегда имеет доступ к самым актуальным данным.

2.  **Внедрена система отслеживания ценовых импульсов ("шпилек"):**
    *   **Проблема:** Даже при частом опросе бот мог пропустить кратковременное касание цели (тейк-профита), если оно произошло между итерациями цикла.
    *   **Решение:** Теперь бот собирает все цены, поступившие за время паузы, и находит среди них максимальное (`batch_max`) и минимальное (`batch_min`) значения.
    *   **Результат:** Проверка условий TP/SL/усреднений теперь идет по экстремумам свечи внутри цикла. Если цена коснулась цели на долю секунды и вернулась обратно, бот гарантированно зафиксирует это событие.

3.  **Оптимизация проверки условий:**
    *   Для **LONG**: Take Profit проверяется по максимуму за период, а усреднение/алерты — по минимуму.
    *   Для **SHORT**: Take Profit проверяется по минимуму за период, а усреднение/алерты — по максимуму.
